<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fam-Chat Simple</title>
<style>
body{font-family:sans-serif;margin:0;padding:0;}
#login,#name,#chat{display:none;max-width:400px;margin:50px auto;padding:20px;border:1px solid #ccc;border-radius:10px;}
#messages{height:300px;overflow-y:auto;border:1px solid #ccc;padding:10px;margin-bottom:10px;}
.message{margin-bottom:5px;}
</style>
</head>
<body>
<div id="login">
  <h3>Login / Signup</h3>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" placeholder="Password" type="password"><br><br>
  <button onclick="signUp()">Sign Up</button>
  <button onclick="signIn()">Sign In</button>
  <p id="loginError" style="color:red"></p>
</div>

<div id="name">
  <h3>Enter your display name</h3>
  <input id="displayName" placeholder="Name"><br><br>
  <button onclick="saveName()">Continue</button>
</div>

<div id="chat">
  <h3>Fam-Chat</h3>
  <div id="messages"></div>
  <input id="messageInput" placeholder="Type a message">
  <button onclick="sendMessage()">Send</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCx8SYiBF9EUtcsJESyT7ZJcN8m4zd0fE8",
  authDomain: "famchat-624ab.firebaseapp.com",
  databaseURL: "https://famchat-624ab-default-rtdb.firebaseio.com",
  projectId: "famchat-624ab",
  storageBucket: "famchat-624ab.firebasestorage.app",
  messagingSenderId: "686126582474",
  appId: "1:686126582474:web:0b207958778479fa768233"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentName = "";

// Show login at start
document.getElementById('login').style.display="block";

auth.onAuthStateChanged(user=>{
  if(user){
    db.ref("users/"+user.uid+"/name").once("value").then(snap=>{
      const name = snap.val();
      if(name){ currentName = name; showChat(); }
      else { document.getElementById("login").style.display="none"; document.getElementById("name").style.display="block"; }
    });
  } else { document.getElementById("login").style.display="block"; }
});

function signUp(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  auth.createUserWithEmailAndPassword(email,password)
      .then(()=>alert("Account created! Sign in now."))
      .catch(err=>document.getElementById("loginError").innerText=err.message);
}

function signIn(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  auth.signInWithEmailAndPassword(email,password)
      .catch(err=>document.getElementById("loginError").innerText=err.message);
}

function saveName(){
  const nameInput = document.getElementById("displayName").value.trim();
  if(!nameInput) return alert("Enter a name");
  const user = auth.currentUser;
  db.ref("users/"+user.uid).set({ name: nameInput });
  currentName=nameInput;
  showChat();
}

function showChat(){
  document.getElementById("login").style.display="none";
  document.getElementById("name").style.display="none";
  document.getElementById("chat").style.display="block";
  loadMessages();
}

function loadMessages(){
  const messagesDiv=document.getElementById("messages");
  db.ref("messages").off();
  db.ref("messages").on("child_added",snap=>{
    const msg=snap.val();
    const div=document.createElement("div");
    div.classList.add("message");
    div.textContent=msg.name+": "+msg.text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

function sendMessage(){
  const input=document.getElementById("messageInput");
  if(!input.value.trim()) return;
  db.ref("messages").push({
    text: input.value,
    uid: auth.currentUser.uid,
    name: currentName,
    timestamp: Date.now()
  });
  input.value="";
}
</script>
</body>
</html>
